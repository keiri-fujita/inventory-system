<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>{{ base_name }}の在庫</title>
<style>
body { font-size: 13px; }

/* 集計テーブル */
.summary {
  font-size: 12px;
  border-collapse: collapse;
  background: #fff;
  line-height: 1.1;
}
.summary th,
.summary td {
  border: 1px solid #ccc;
  padding: 1px 4px;
  text-align: right;
  white-space: nowrap;
}
.summary thead th {
  text-align: center;
  background-color: #ffe6ea !important;
  font-weight: bold;
}
.summary tbody tr:hover {
  background: none;
  font-weight: normal;
  transition: none;
}

/* 在庫テーブル */
table {
  border-collapse: collapse;
  width: 100%;
  font-size: 12px;

  /* ★ 画面の高さからヘッダーぶんを引いた高さまで使う */
  max-height: calc(100vh - 220px);

  overflow-y: auto;
  display: block;
}

th, td {
  border: 1px solid #ccc;
  padding: 4px 8px;
  text-align: center;
  white-space: nowrap;
}
th.sortable { cursor: pointer; }

thead tr:first-child th {
  position: sticky;
  top: 0;
  background-color: #ccf0ff;
  z-index: 3;
}
thead tr:nth-child(2) th {
  position: sticky;
  top: 28px;
  background: #fff;
  z-index: 2;
}

tbody tr:hover {
  background-color: #fffacd;
  font-weight: bold;
  transition: all .2s ease;
}

select {
  font-size: 11px;
  width: 100%;
}
.sort-icon {
  margin-left: 4px;
  font-size: 10px;
}


/* --- ヘッダー部分のレイアウト --- */

/* 集計表＋ボタン全体のコンテナ */
.header-controls {
  display: flex;
  align-items: flex-end;   /* ★ 下端をそろえる */
  gap: 56px;
  margin-bottom: 8px;
  flex-wrap: wrap;
}

/* 左：集計表側の余白調整（上の余白はナシ） */
.summary-wrap {
  margin-top: 0;
}


/* 右：ボタン＋検索を上下2段にまとめる */
.controls-right {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

/* 各段のボタン並び */
.controls-row {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
}
</style>
</head>
<body>
<h1>{{ base_name }}の在庫</h1>

<form method="POST" id="inventory-form">

  <!-- ★ 集計表（左）＋ ボタン群（右） -->
  <div class="header-controls">

    <!-- 左：集計表 -->
    <div class="summary-wrap">
      {% set cats = ["リング","ペンダント","チェーン","その他"] %}
      <table class="summary" aria-label="在庫集計">
        <thead>
          <tr>
            <th>アイテム</th><th>数量</th><th>上代</th><th>下代</th>
          </tr>
        </thead>
        <tbody>
          {% for c in cats %}
          <tr>
            <td>{{ c }}</td>
            <td>{{ summary[c]["count"] }}</td>
            <td>{{ summary[c]["上代"] }}</td>
            <td>{{ summary[c]["下代"] }}</td>
          </tr>
          {% endfor %}
          <tr style="font-weight:700;">
            <td>合計</td>
            <td>{{ (totals.count | default(total_count)) }}</td>
            <td>{{ (totals["上代"] | default(total_上代)) }}</td>
            <td>{{ (totals["下代"] | default(total_下代)) }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 右：ボタン・検索など（2段） -->
    <div class="controls-right">

      <!-- 1段目 -->
      <div class="controls-row">
        <button type="button" id="btn-checkout">チェックした在庫を出庫する</button>
        <button type="button" id="btn-uncheck-all">全てのチェックを外す</button>

        <label style="font-size: 12px;">
          <input type="checkbox" id="chk-show-only-checked">
          チェック行のみ表示
        </label>
      </div>

      <!-- 2段目 -->
      <div class="controls-row">
        <button type="button" onclick="resetFilters()">フィルタ解除</button>
        <button type="button" id="btn-print-filtered" class="print-button">在庫表印刷</button>
        <button type="button" id="btn-open-tag-dialog">値札印刷</button>

        <input
          type="text"
          id="searchBox"
          placeholder="キーワード検索（例：品番・金額など）"
          style="padding: 4px; font-size: 12px; width: 250px;"
        />

        <span id="countLabel" style="font-size: 12px; white-space: nowrap;">
          表示件数：0 / 総件数：0
        </span>
      </div>

    </div>
  </div>

  <!-- ▼ この下は今まで通り（メインテーブル） ▼ -->

  <table id="inventoryTable">
    <thead>
      <tr>
        <th>出庫</th>
        <th>編集</th>
        {% for i in range(1,13) %}
          <th class="sortable" onclick="sortTable({{ i+1 }}, this)">
            {{ headers[i] }}<span class="sort-icon">▼</span>
          </th>
        {% endfor %}
      </tr>
      <tr>
        <th></th>
        <th></th>
        {% for i in range(1,13) %}
        <th>
          <select onchange="applyFiltersAndSearch()" data-col="{{ i+1 }}">
            <option value="">すべて</option>
          </select>
        </th>
        {% endfor %}
      </tr>
    </thead>

    <tbody>
      {% for i, row in enumerate(rows) %}
      <tr data-no="{{ row[0] }}">
        <td><input type="checkbox" name="checkout" value="{{ i }}"></td>
        <td>
          <a href="{{ url_for('edit_inventory_row', base_name=base_name, no=row[0]) }}">編集</a>
        </td>
        {% for cell in row[2:14] %}
          <td>{{ cell }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</form>

<p><a href="/">← 戻る</a></p>

<!-- ================= JS（検索・フィルタ・ソート・印刷） ================= -->
<script>
const BASE_NAME = "{{ base_name }}";
let sortOrder = {};
let searchTimeout = null;

window.addEventListener('DOMContentLoaded', function () {
  const table   = document.getElementById("inventoryTable");
  const tbody   = table.tBodies[0];
  const selects = table.querySelectorAll("thead tr:nth-child(2) select");

  // セレクトの候補値
  selects.forEach(select => {
    const colIndex = parseInt(select.dataset.col, 10);
    const values = new Set();

    Array.from(tbody.rows).forEach(tr => {
      const cell = tr.cells[colIndex];
      if (!cell) return;
      const text = cell.textContent.trim();
      if (text) values.add(text);
    });

    Array.from(values).sort().forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      select.appendChild(opt);
    });
  });

  // 検索ボックス
  document.getElementById("searchBox").addEventListener("input", function () {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(applyFiltersAndSearch, 400);
  });

  // 在庫表印刷
  const btnPrintFiltered = document.getElementById("btn-print-filtered");
  if (btnPrintFiltered) {
    btnPrintFiltered.addEventListener("click", printFilteredInventory);
  }

  // 値札印刷ダイアログ
  const btnTagDialog = document.getElementById("btn-open-tag-dialog");
  if (btnTagDialog) {
    btnTagDialog.addEventListener("click", openTagPrintDialog);
  }

  // チェック行のみ表示
  const chkShowOnly = document.getElementById("chk-show-only-checked");
  if (chkShowOnly) {
    chkShowOnly.addEventListener("change", function() {
      if (this.checked) {
        showOnlyCheckedRows();
      } else {
        applyFiltersAndSearch();
      }
    });
  }

  updateCountLabel();
});

function updateCountLabel() {
  const tbody  = document.querySelector("#inventoryTable tbody");
  const total  = tbody.rows.length;
  let visible  = 0;
  Array.from(tbody.rows).forEach(tr => {
    if (tr.style.display !== "none") visible++;
  });
  document.getElementById("countLabel").textContent =
    `表示件数：${visible} / 総件数：${total}`;
}

function resetFilters() {
  const table   = document.getElementById("inventoryTable");
  const tbody   = table.tBodies[0];
  const selects = table.querySelectorAll("thead tr:nth-child(2) select");
  const search  = document.getElementById("searchBox");
  const chkShowOnly = document.getElementById("chk-show-only-checked");

  selects.forEach(sel => sel.value = "");
  search.value = "";
  if (chkShowOnly) chkShowOnly.checked = false;

  Array.from(tbody.rows).forEach(tr => tr.style.display = "");
  updateCountLabel();
}

function applyFiltersAndSearch() {
  const table   = document.getElementById("inventoryTable");
  const tbody   = table.tBodies[0];
  const selects = table.querySelectorAll("thead tr:nth-child(2) select");
  const searchValue = document.getElementById("searchBox").value.trim().toLowerCase();
  const searchWords = searchValue.split(/\s+/).filter(w => w);

  Array.from(tbody.rows).forEach(tr => {
    let visible = true;
    const cells = tr.cells;

    selects.forEach(select => {
      const col = parseInt(select.dataset.col, 10);
      const val = select.value.trim().toLowerCase();
      if (!val) return;
      const cell = cells[col];
      const text = cell ? cell.textContent.trim().toLowerCase() : "";
      if (!text.includes(val)) visible = false;
    });

    if (visible && searchWords.length > 0) {
      const rowText = Array.from(cells)
        .map(td => td.textContent.trim().toLowerCase().replace(/,/g, ""))
        .join(" ");
      for (const w of searchWords) {
        const term = w.replace(/,/g, "");
        if (!rowText.includes(term)) {
          visible = false;
          break;
        }
      }
    }

    tr.style.display = visible ? "" : "none";
  });

  updateCountLabel();
}

// 在庫表印刷（絞り込み結果）
function printFilteredInventory() {
  const table = document.getElementById("inventoryTable");
  const tbody = table.tBodies[0];
  const visibleRows = Array.from(tbody.rows).filter(tr => tr.style.display !== "none");

  if (visibleRows.length === 0) {
    alert("表示されている行がありません。");
    return;
  }

  const headerCells = Array.from(table.tHead.rows[0].cells).slice(2);
  const headers = headerCells.map(th => th.textContent.trim());

  const printWin = window.open("", "_blank");
  const doc = printWin.document;

  doc.open();
  doc.write(`<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>${BASE_NAME} 在庫一覧</title>
<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    font-size: 11pt;
    color: #333;
  }
  .print-container {
    padding-top: 10mm;
    padding-bottom: 10mm;
    padding-left: 0;
    padding-right: 0;
    text-align: center;
  }
  table {
    margin-left: auto;
    margin-right: auto;
    width: auto;
    border-collapse: collapse;
    page-break-inside: auto;
  }
  thead { display: table-header-group; }
  tr {
    page-break-inside: avoid;
    page-break-after: auto;
  }
  th, td {
    border: 1px solid #999;
    padding: 3px 4px;
    text-align: left;
    vertical-align: top;
    font-size: 10pt;
    white-space: nowrap;
    line-height: 1.4;
  }
  th { background: #f0f0f0; }
  .table-title-row th {
    background: #ffffff;
    font-size: 14pt;
    text-align: center;
    padding: 6px 0;
    border-bottom: 2px solid #666;
  }
  @page {
    size: A4 portrait;
    margin: 15mm 6mm 15mm 6mm;
  }

/* ▼ フォーム内のボタン共通デザイン（ここから追加） */
#inventory-form button {
  padding: 4px 10px;
  background: #eeeeee;
  border: 1px solid #cccccc;
  border-radius: 4px;
  font-size: 12px;
  color: #333;
  cursor: pointer;
}

#inventory-form button:hover {
  background: #dddddd;
}
/* ▲ ここまで追加 */

</style>
</head>

<body>
<div class="print-container">
<table>
  <thead>
    <tr class="table-title-row">
      <th colspan="${headers.length + 1}">${BASE_NAME} 在庫一覧</th>
    </tr>
    <tr>
      <th>No.</th>
      ${headers.map(h => `<th>${h}</th>`).join("")}
    </tr>
  </thead>
  <tbody>
`);

  visibleRows.forEach(tr => {
    const no = tr.dataset.no || "";
    const cells = Array.from(tr.cells).slice(2).map(td => td.textContent.trim());
    doc.write("<tr>");
    doc.write(`<td>${no}</td>`);
    cells.forEach(text => {
      doc.write(`<td>${text}</td>`);
    });
    doc.write("</tr>");
  });

  doc.write(`
  </tbody>
</table>
</div>
</body>
</html>`);
  doc.close();

  printWin.focus();
  printWin.print();
}

// ソート
function sortTable(colIndex, headerCell) {
  if (colIndex === 0 || colIndex === 1) return;

  const table = document.getElementById("inventoryTable");
  const tbody = table.tBodies[0];
  const rows  = Array.from(tbody.rows);

  const asc = !(sortOrder[colIndex]);
  sortOrder[colIndex] = asc;

  rows.sort((a, b) => {
    const A = (a.cells[colIndex]?.textContent || "").trim().replace(/,/g, "");
    const B = (b.cells[colIndex]?.textContent || "").trim().replace(/,/g, "");
    const numA = parseFloat(A);
    const numB = parseFloat(B);

    if (!isNaN(numA) && !isNaN(numB)) {
      return asc ? numA - numB : numB - numA;
    }
    return asc ? A.localeCompare(B, "ja") : B.localeCompare(A, "ja");
  });

  rows.forEach(tr => tbody.appendChild(tr));

  document.querySelectorAll(".sort-icon").forEach(i => i.textContent = "▼");
  headerCell.querySelector(".sort-icon").textContent = asc ? "▲" : "▼";

  applyFiltersAndSearch();
}

/* ========= 値札印刷 ========= */

function openTagPrintDialog() {
  const table = document.getElementById("inventoryTable");
  const tbody = table.tBodies[0];
  const checkedCount = tbody.querySelectorAll('input[name="checkout"]:checked').length;
  const hasChecked = checkedCount > 0;

  Swal.fire({
    title: '値札印刷',
    html: `
      <div style="text-align:left; font-size:13px;">
        <p style="margin-bottom:6px;">① どの行を値札にしますか？</p>
        <label style="display:block; margin-left:8px; margin-bottom:4px;">
          <input type="radio" name="tag-scope" value="checked" ${hasChecked ? 'checked' : 'disabled'}>
          チェックした行だけ印刷 ${
            hasChecked ? '（' + checkedCount + '件）' : '（チェックがありません）'
          }
        </label>
        <label style="display:block; margin-left:8px; margin-bottom:10px;">
          <input type="radio" name="tag-scope" value="filtered" ${hasChecked ? '' : 'checked'}>
          絞り込み後の表示行すべて
        </label>

        <p style="margin-bottom:6px;">② 値札の種類を選んでください：</p>
        <label style="display:block; margin-left:8px;">
          <input type="radio" name="tag-type" value="proper" checked>
          プロパー値札
        </label>
        <label style="display:block; margin-left:8px;">
          <input type="radio" name="tag-type" value="event">
          催事用値札
        </label>
      </div>
    `,
    focusConfirm: false,
    showCancelButton: true,
    confirmButtonText: '印刷する',
    cancelButtonText: 'キャンセル',
    width: 480,
    preConfirm: () => {
      const scope = document.querySelector('input[name="tag-scope"]:checked');
      const type  = document.querySelector('input[name="tag-type"]:checked');
      if (!scope || !type) {
        Swal.showValidationMessage('対象行と値札の種類を選択してください。');
        return false;
      }
      if (scope.value === 'checked' && !hasChecked) {
        Swal.showValidationMessage('チェックされた行がありません。');
        return false;
      }
      return { mode: scope.value, tagType: type.value };
    }
  }).then((result) => {
    if (result.isConfirmed && result.value) {
      openTagPrint(result.value.mode, result.value.tagType);
    }
  });
}

function openTagPrint(mode, tagType) {
  const baseName = "{{ base_name }}";
  const table = document.getElementById("inventoryTable");
  const tbody = table.tBodies[0];

  let nos = [];

  if (mode === "checked") {
    const checks = tbody.querySelectorAll('input[name="checkout"]:checked');
    checks.forEach(chk => {
      const tr = chk.closest("tr");
      const no = tr.dataset.no;
      if (no) nos.push(no);
    });
  } else if (mode === "filtered") {
    Array.from(tbody.rows).forEach(tr => {
      if (tr.style.display === "none") return;
      const no = tr.dataset.no;
      if (no) nos.push(no);
    });
  }

  if (nos.length === 0) {
    alert("値札を作成する行が選ばれていません。");
    return;
  }

  const params = new URLSearchParams();
  params.set("type", tagType);
  params.set("nos", nos.join(","));

  const url = `/print_tags/${encodeURIComponent(baseName)}?` + params.toString();
  window.open(url, "_blank");
}

function showOnlyCheckedRows() {
  const table = document.getElementById("inventoryTable");
  const tbody = table.tBodies[0];

  Array.from(tbody.rows).forEach(tr => {
    const chk = tr.querySelector('input[name="checkout"]');
    if (chk && chk.checked) {
      tr.style.display = "";
    } else {
      tr.style.display = "none";
    }
  });

  updateCountLabel();
}

function clearAllChecks() {
  const checks = document.querySelectorAll(
    "#inventoryTable tbody input[name='checkout']"
  );
  checks.forEach(chk => {
    chk.checked = false;
  });

  const chkShowOnly = document.getElementById("chk-show-only-checked");
  if (chkShowOnly && chkShowOnly.checked) {
    chkShowOnly.checked = false;
    applyFiltersAndSearch();
  }
}
</script>

<!-- SweetAlert2（出庫確認） -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('inventory-form');
    const btn  = document.getElementById('btn-checkout');
    const btnUncheck = document.getElementById('btn-uncheck-all');
    if (!form || !btn) return;

    btn.addEventListener('click', function () {
      const checked = form.querySelectorAll('input[name="checkout"]:checked');
      const count = checked.length;

      if (count === 0) {
        Swal.fire({
          icon: 'error',
          title: '出庫する在庫にチェックを付けてください。',
          confirmButtonColor: '#3085d6'
        });
        return;
      }

      Swal.fire({
        title: `${count}件を出庫します。よろしいですか？`,
        text: 'この操作は取り消せません。',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#aaaaaa',
        confirmButtonText: '出庫する',
        cancelButtonText: 'キャンセル',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit();
        }
      });
    });

    if (btnUncheck) {
      btnUncheck.addEventListener('click', clearAllChecks);
    }
  });
</script>

</body>
</html>
