<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>{{ title }}</title>

  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .page-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #fff;
      z-index: 20;
      padding: 12px 2em 6px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .page-header h1 {
      margin: 0;
      display: inline-block;
    }
    .back-link {
      float: right;
      margin-top: 4px;
      text-decoration: none;
    }

    .table-container {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 8px 2em 16px;
      overflow-y: auto;
      background: #fff;
      box-sizing: border-box;
    }

    .filter-bar {
      position: sticky;
      top: 0;
      z-index: 15;
      background: #fff;
      padding-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      margin: 0;
    }

    th, td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 4px 6px;

      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    thead th {
      background: #eee;
    }

    thead tr:first-child th {
      position: sticky;
      top: 30px;
      z-index: 10;
    }

    thead tr.filter-row th {
      position: sticky;
      top: 54px;
      z-index: 11;
      background: #f5f5f5;
    }

    tbody tr:hover {
      background: #e5f7ea;
      font-weight: 600;
    }

    .filter-select {
      width: 100%;
      font-size: 12px;
      box-sizing: border-box;
    }

    .memo-input {
      width: 100%;
      box-sizing: border-box;
      font-size: 12px;
    }

    .submit-area {
      margin-top: 8px;
      text-align: right;
    }
  </style>
</head>

<body>

  <div class="page-header">
    <h1>{{ title }}</h1>
    <a href="/" class="back-link">← 戻る</a>
  </div>

  <div class="table-container">

    <form method="POST">
      <div class="filter-bar">
        <button type="button" id="reset-filters">フィルタをすべて解除</button>
        <button type="submit">メモを保存する</button>
      </div>

      {# 出庫ログでは「処理」「No.」「下代（数値）」は非表示 #}
      {% set hide_headers = ["処理", "No.", "下代（数値）"] %}

      <table>
        <thead>
          <tr>
            {% for h in headers %}
              {% if h not in hide_headers %}
                <th>{{ h }}</th>
              {% endif %}
            {% endfor %}
          </tr>

          <tr class="filter-row">
            {% for h in headers %}
              {% if h not in hide_headers %}
                <th>
                  <select class="filter-select">
                    <option value="">すべて</option>
                  </select>
                </th>
              {% endif %}
            {% endfor %}
          </tr>
        </thead>

        <tbody>
          {# rows と row_indices を対応させる #}
          {% for i in range(rows|length) %}
            {% set row = rows[i] %}
            {% set row_index = row_indices[i] %}
            <tr>
              {# この行が log.csv の何行目かを hidden で送る #}
              <input type="hidden" name="row_index[]" value="{{ row_index }}">

              {% for cell in row %}
                {% set h = headers[loop.index0] %}
                {% if h not in hide_headers %}
                  {% if h == "メモ" %}
                    <td>
                      <input type="text" name="memo[]" value="{{ cell }}" class="memo-input">
                    </td>
                  {% else %}
                    <td>{{ cell }}</td>
                  {% endif %}
                {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="submit-area">
        <button type="submit">メモを保存する</button>
      </div>
    </form>

  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const table = document.querySelector("table");
      if (!table) return;

      const tbody = table.tBodies[0];
      const filterRow = table.tHead.querySelector(".filter-row");
      if (!tbody || !filterRow) return;

      const selects = Array.from(filterRow.querySelectorAll("select"));
      selects.forEach((sel, idx) => sel.dataset.col = idx);

      // 列ごとの選択肢を作成
      selects.forEach(sel => {
        const col = Number(sel.dataset.col);
        const values = new Set();
        for (const tr of tbody.rows) {
          const cell = tr.cells[col];
          if (!cell) continue;
          const text = cell.textContent.trim();
          if (text) values.add(text);
        }
        Array.from(values).sort().forEach(v => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          sel.appendChild(opt);
        });
      });

      function applyFilters() {
        const conditions = selects
          .filter(sel => sel.value !== "")
          .map(sel => ({ col: Number(sel.dataset.col), value: sel.value }));

        for (const tr of tbody.rows) {
          let visible = true;
          for (const c of conditions) {
            const cell = tr.cells[c.col];
            if (!cell) continue;
            const text = cell.textContent.trim();
            if (text !== c.value) {
              visible = false;
              break;
            }
          }
          tr.style.display = visible ? "" : "none";
        }
      }

      selects.forEach(sel => sel.addEventListener("change", applyFilters));

      const resetBtn = document.getElementById("reset-filters");
      if (resetBtn) {
        resetBtn.addEventListener("click", () => {
          selects.forEach(sel => sel.value = "");
          Array.from(tbody.rows).forEach(tr => tr.style.display = "");
        });
      }

      // ★ テキストセルだけ自動縮小（メモ入力は除外）
      function autoShrinkCells() {
        const MIN_SIZE = 9;
        const STEP = 0.5;

        const cells = table.querySelectorAll("tbody td");
        cells.forEach(td => {
          // メモ列（input を含むセル）はここでは触らない
          if (td.querySelector("input.memo-input")) return;

          let size = parseFloat(getComputedStyle(td).fontSize);
          if (isNaN(size)) size = 13;

          while (td.scrollWidth > td.clientWidth && size > MIN_SIZE) {
            size -= STEP;
            td.style.fontSize = size + "px";
          }
        });
      }

      autoShrinkCells();
      // window.addEventListener('resize', autoShrinkCells); // 必要なら
    });
  </script>

</body>
</html>
